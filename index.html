<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SV Stephanie</title>
  <style>
    :root{
      --bg:#e9d7cf;
      --line:#1a1a1a;
      --accent:#b0162e;
      --accent2:#ff4d6d;
      --text:#2b2b2b;
      --tree:#7a4b2a;

      /* vh estable para m√≥vil */
      --vh: 1vh;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      overflow:hidden;
      color:var(--text);
    }

    .stage{
      position:relative;
      width:100vw;
      height: calc(var(--vh) * 100);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }

    .ground{
      position:absolute;
      left:0; right:0;
      bottom:64px;
      height:2px;
      background:var(--line);
      opacity:.9;
    }

    /* Intro */
    .intro{
      position:relative;
      display:flex;
      align-items:center;
      gap:14px;
      padding:12px 18px;
      border-radius:18px;
      user-select:none;
      transform: translateY(-20px);
      animation: popIn .7s ease both;
      max-width: calc(100vw - 24px);
    }
    @keyframes popIn{
      from{opacity:0; transform:translateY(-30px) scale(.98)}
      to{opacity:1; transform:translateY(-20px) scale(1)}
    }

    .heart-btn{
      width:58px;
      height:52px;
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: transform .15s ease;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,.10));
      flex: 0 0 auto;
    }
    .heart-btn:active{transform:scale(.96)}
    .intro .label{
      font-weight:600;
      color: #7a0c1a;
      letter-spacing:.2px;
      white-space:nowrap;
      position:relative;
      padding-bottom:4px;
    }
    .intro .label::after{
      content:"";
      position:absolute;
      left:0; right:0;
      bottom:0;
      height:2px;
      background:#7a0c1a;
      opacity:.45;
      border-radius:99px;
    }

    /* Texto */
    .text-panel{
      position:absolute;
      left:64px;
      top:84px;
      width:min(520px, calc(100vw - 120px));
      opacity:0;
      transform: translateY(8px);
      transition: opacity .6s ease, transform .6s ease;
      pointer-events:none;
    }
    .text-panel.show{ opacity:1; transform: translateY(0); }

    .title{
      font-weight:700;
      margin:0 0 12px 0;
      font-size: 18px;
      opacity:.9;
    }
    .typing{
      font-size: 16px;
      line-height:1.5;
      margin:0;
      white-space:pre-wrap;
    }
    .caret{
      display:inline-block;
      width:8px;
      height:16px;
      transform: translateY(3px);
      margin-left:2px;
      background: rgba(0,0,0,.6);
      animation: blink 1s steps(2,end) infinite;
    }
    @keyframes blink{ 50%{opacity:0} }

    /* Contador */
    .counter{
      position:absolute;
      left:64px;
      bottom:22px;
      font-size:13px;
      opacity:.88;
      letter-spacing:.2px;
      background: rgba(255,255,255,.25);
      padding:10px 12px;
      border-radius:12px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      max-width: calc(100vw - 140px);
    }
    .counter strong{font-weight:700}

    /* M√∫sica */
    .music{
      position:absolute;
      right:20px;
      bottom:18px;
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(255,255,255,.25);
      padding:10px 12px;
      border-radius:12px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    .music button{
      cursor:pointer;
      border:0;
      border-radius:10px;
      padding:8px 10px;
      font-weight:600;
      background: rgba(176,22,46,.12);
      color:#7a0c1a;
      transition: transform .12s ease, background .2s ease;
      white-space:nowrap;
    }
    .music button:active{transform:scale(.98)}
    .music input[type="range"]{width:120px}
    .hidden{display:none}

    /* ‚úÖ Ajustes espec√≠ficos m√≥vil */
    @media (max-width: 520px){
      .text-panel{
        left:16px;
        top:70px;
        width: calc(100vw - 32px);
      }
      .title{ font-size:16px; }
      .typing{ font-size:15px; }

      .counter{
        left:16px;
        right:16px;
        bottom:16px;
        max-width: none;
      }
      .music{
        right:16px;
        bottom:86px; /* encima del contador */
      }
      .music input[type="range"]{ width:90px; }

      .intro{
        padding:10px 14px;
        gap:10px;
      }
    }
  </style>
</head>
<body>
  <div class="stage">
    <canvas id="scene"></canvas>
    <div class="ground"></div>

    <div class="intro" id="intro">
      <div class="heart-btn" id="startBtn" aria-label="Iniciar">
        <svg width="58" height="52" viewBox="0 0 64 56" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M32 54s-2.9-2.2-6.5-5.1C14.8 40.7 4 32.1 4 19.7 4 10.9 10.7 4 19.2 4c5 0 9.6 2.6 12.8 6.6C35.2 6.6 39.8 4 44.8 4 53.3 4 60 10.9 60 19.7c0 12.4-10.8 21-21.5 29.2C34.9 51.8 32 54 32 54z"
                fill="var(--accent)" />
        </svg>
      </div>
      <div class="label">Stephanie</div>
    </div>

    <div class="text-panel" id="textPanel">
      <p class="title" id="textTitle">Para el amor de mi vida:</p>
      <p class="typing" id="typing"></p>
    </div>

    <div class="counter" id="counter">
      Mi amor por ti comenz√≥ hace‚Ä¶<br>
      <strong id="counterValue">‚Äî</strong>
    </div>

    <div class="music" id="musicUI">
      <button id="toggleMusic">‚ñ∂Ô∏é</button>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="0.65" />
    </div>

    <audio id="song" preload="auto"></audio>
  </div>

  <script>
    /*****************************************************************
     * CONFIG (EDITA AQU√ç)
     *****************************************************************/
    const START_DATE_ISO = "2025-02-14T00:00:00";
    const TYPEWRITER_TEXT = [
      "Si pudiera elegir un lugar seguro, ser√≠a a tu lado.",
      "",
      "Gracias por existir, por quedarte y por hacer mi vida m√°s bonita. ‚ù§Ô∏è",
      "",
      "Eres mi calma en los d√≠as dif√≠ciles, mi risa inesperada, mi abrazo favorito.",
      "Contigo todo tiene m√°s sentido, incluso los peque√±os detalles se vuelven eternos.",
      "",
      "Prometo seguir construyendo recuerdos contigo, paso a paso,",
      "cuidando este amor que crece como un √°rbol lleno de corazones.",
      "",
      "Te elijo hoy, ma√±ana y siempre. üíû"
    ].join("\n");

    const SONG_SRC = "Sweet.mp3";

    /*****************************************************************
     * VH ESTABLE (m√≥vil)
     *****************************************************************/
    function setVH(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', setVH);
    window.addEventListener('orientationchange', setVH);
    setVH();

    /*****************************************************************
     * ELEMENTOS
     *****************************************************************/
    const canvas = document.getElementById("scene");
    const ctx = canvas.getContext("2d");

    const intro = document.getElementById("intro");
    const startBtn = document.getElementById("startBtn");

    const textPanel = document.getElementById("textPanel");
    const typingEl = document.getElementById("typing");

    const counterValue = document.getElementById("counterValue");

    const song = document.getElementById("song");
    const toggleMusic = document.getElementById("toggleMusic");
    const vol = document.getElementById("vol");

    /*****************************************************************
     * RESPONSIVE: tama√±o real del ‚Äústage‚Äù
     *****************************************************************/
    function stageSize(){
      // usamos la altura estable que ponemos en CSS
      const h = Math.round(parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--vh')) * 100);
      return { w: window.innerWidth, h };
    }

    function resizeCanvas(){
      const { w, h } = stageSize();
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", resizeCanvas);
    window.addEventListener("orientationchange", resizeCanvas);
    resizeCanvas();

    /*****************************************************************
     * ESTADO ANIMACI√ìN
     *****************************************************************/
    const state = {
      started: false,
      t0: 0,
      phase: "idle",
      growP: 0,
      bloomP: 0,
      hearts: [],
      falling: [],
      wind: 0
    };

    function isMobile(){
      return window.innerWidth <= 520;
    }

    function getBase(){
      const { w, h } = stageSize();
      const groundY = h - 64;

      // ‚úÖ En m√≥vil lo centramos m√°s para que NO se salga
      const x = isMobile() ? w * 0.58 : w * 0.70;
      const y = groundY;
      return { x, y, groundY, w, h };
    }

    /*****************************************************************
     * √ÅRBOL (TRONCO + RAMAS)
     *****************************************************************/
    function drawTrunk(progress){
      const { x, y, h: H } = getBase();

      const hTree = H * 0.46; // proporcional al alto real del stage
      const p = Math.min(1, Math.max(0, progress));
      const treeColor = getComputedStyle(document.documentElement)
        .getPropertyValue("--tree").trim() || "#7a4b2a";

      ctx.save();
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = treeColor;

      function strokeTapered(points){
        for(let i=0;i<points.length-1;i++){
          const a = points[i], b = points[i+1];
          ctx.lineWidth = (a.w + b.w) / 2;
          ctx.beginPath();
          ctx.moveTo(a.x, a.y);
          ctx.lineTo(b.x, b.y);
          ctx.stroke();
        }
      }

      const baseW = 18;
      const sway = isMobile() ? 7 : 10;
      const steps = 20;
      const trunk = [];

      for(let i=0;i<=steps;i++){
        const t = i/steps;
        const yy = y - (hTree * p) * t;

        const xx = x
          + Math.sin(t * 1.8) * (sway * p)
          - Math.sin(t * 3.2) * (sway * 0.35 * p);

        const ww = baseW * (1.10 - 0.75 * t) * (0.85 + 0.15*p);
        trunk.push({x: xx, y: yy, w: ww});
      }

      strokeTapered(trunk);

      if(p > 0.6){
        ctx.save();
        ctx.globalAlpha = 0.08;
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=2;i<trunk.length-2;i+=2){
          ctx.moveTo(trunk[i].x-2, trunk[i].y);
          ctx.lineTo(trunk[i].x+2, trunk[i].y-6);
        }
        ctx.stroke();
        ctx.restore();
      }

      function branch(fromIdx, dir, len, lift, thickness, appearAt){
        if(p < appearAt) return;
        const q = Math.min(1, (p - appearAt) / (1 - appearAt));

        const start = trunk[Math.max(0, Math.min(trunk.length-1, fromIdx))];
        const bx0 = start.x;
        const by0 = start.y;

        const pts = [];
        const n = 12;

        for(let i=0;i<=n;i++){
          const t = i/n;
          const ease = t*t*(3-2*t);
          const xx = bx0 + dir * len * ease * q + Math.sin(t*3.2) * 4 * q;
          const yy = by0 - lift * ease * q - t*6*q;
          const ww = thickness * (1 - 0.75*t) * (0.9 + 0.1*q);
          pts.push({x: xx, y: yy, w: ww});
        }
        strokeTapered(pts);

        if(q > 0.5){
          const mid = pts[Math.floor(pts.length * 0.55)];
          const pts2 = [];
          const n2 = 9;
          const len2 = len * 0.45;
          const lift2 = lift * 0.45;

          for(let i=0;i<=n2;i++){
            const t = i/n2;
            const ease = t*t*(3-2*t);
            const xx = mid.x + dir * len2 * ease * q + Math.sin(t*4.0)*3*q;
            const yy = mid.y - lift2 * ease * q - t*4*q;
            const ww = (thickness*0.55) * (1 - 0.8*t);
            pts2.push({x: xx, y: yy, w: ww});
          }
          strokeTapered(pts2);
        }
      }

      // ‚úÖ En m√≥vil acortamos un poco las ramas para que no se corten
      const scale = isMobile() ? 0.82 : 1.0;

      const idxA = Math.floor(trunk.length * 0.45);
      const idxB = Math.floor(trunk.length * 0.58);
      const idxC = Math.floor(trunk.length * 0.70);
      const idxD = Math.floor(trunk.length * 0.78);

      branch(idxA, -1, 70*scale, 55*scale, 8.5*scale, 0.55);
      branch(idxA,  1, 75*scale, 58*scale, 8.0*scale, 0.55);

      branch(idxB, -1, 85*scale, 70*scale, 7.5*scale, 0.62);
      branch(idxB,  1, 88*scale, 72*scale, 7.0*scale, 0.62);

      branch(idxC, -1, 70*scale, 65*scale, 6.0*scale, 0.70);
      branch(idxC,  1, 72*scale, 66*scale, 5.8*scale, 0.70);

      branch(idxD, -1, 55*scale, 55*scale, 4.8*scale, 0.78);
      branch(idxD,  1, 58*scale, 56*scale, 4.6*scale, 0.78);

      ctx.restore();
    }

    /*****************************************************************
     * COPA DE CORAZ√ìN (HOJAS)
     *****************************************************************/
    function heartShapePoints(n){
      const pts = [];
      for(let i=0;i<n;i++){
        const t = Math.random() * Math.PI * 2;

        const x = 16 * Math.pow(Math.sin(t),3);
        const y = 13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t);

        const nx = x / 18;
        const ny = -y / 18;

        const r = Math.pow(Math.random(), 0.35);
        pts.push({ x: nx * r, y: ny * r });
      }
      return pts;
    }

    function createCanopy(){
      const { x, y, h: H, w: W } = getBase();
      const hTree = H * 0.46;
      const topY = y - hTree;

      // ‚úÖ mover copa un poco para m√≥vil
      const centerX = isMobile() ? (x + 2) : (x + 8);
      const centerY = isMobile() ? (topY + 62) : (topY + 55);

      // ‚úÖ copa un poco m√°s peque√±a en m√≥vil para que no se corte
      const scaleBase = isMobile() ? 0.16 : 0.18;
      const scale = Math.min(W, H) * scaleBase;

      const pts = heartShapePoints(isMobile() ? 420 : 520);
      state.hearts = pts.map(p => {
        const size = (isMobile() ? 7 : 8) + Math.random()*10;
        const mix = Math.random();
        const col = (mix < 0.55) ? "rgba(176,22,46,0.95)" : "rgba(255,77,109,0.90)";
        return {
          x: centerX + p.x * scale + (Math.random()*10-5),
          y: centerY + p.y * scale + (Math.random()*10-5),
          s: size,
          a: 0,
          rot: Math.random()*Math.PI,
          col
        };
      });
    }

    function drawHeartLeaf(x,y,size,rot,alpha,color){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(rot);
      ctx.globalAlpha = alpha;
      ctx.fillStyle = color;

      ctx.beginPath();
      const s = size/2;
      ctx.moveTo(0, s*0.7);
      ctx.bezierCurveTo(-s, -s*0.1, -s, -s*1.2, 0, -s*0.6);
      ctx.bezierCurveTo(s, -s*1.2, s, -s*0.1, 0, s*0.7);
      ctx.fill();

      ctx.restore();
    }

    function drawCanopy(progress){
      const p = Math.min(1, Math.max(0, progress));
      for(const h of state.hearts){
        const appear = Math.min(1, Math.max(0, (p*1.15) - Math.random()*0.25));
        h.a = appear;
        const wobble = (1-p) * 0.15;

        drawHeartLeaf(
          h.x,
          h.y,
          h.s * (0.85 + 0.15*p),
          h.rot + (Math.random()*wobble - wobble/2),
          h.a,
          h.col
        );
      }
    }

    /*****************************************************************
     * HOJAS CAYENDO
     *****************************************************************/
    function spawnFalling(count){
      for(let i=0;i<count;i++){
        const src = state.hearts[Math.floor(Math.random()*state.hearts.length)];
        if(!src) continue;

        state.falling.push({
          x: src.x + (Math.random()*18-9),
          y: src.y + (Math.random()*18-9),
          s: src.s * (0.7 + Math.random()*0.6),
          vy: 0.6 + Math.random()*1.4,
          vx: (Math.random()*0.8-0.4),
          rot: Math.random()*Math.PI,
          vr: (Math.random()*0.02-0.01),
          life: 0,
          maxLife: 600 + Math.random()*500,
          col: src.col,
          alpha: 0.9
        });
      }
    }

    function updateFalling(){
      const wind = state.wind;
      for(const f of state.falling){
        f.life += 1;
        f.vx += (Math.random()*0.02-0.01) + wind*0.002;
        f.x += f.vx;
        f.y += f.vy;
        f.rot += f.vr;

        const end = f.life / f.maxLife;
        if(end > 0.8) f.alpha = Math.max(0, 0.9 * (1 - (end-0.8)/0.2));
      }
      state.falling = state.falling.filter(f => f.y < stageSize().h + 40 && f.alpha > 0.01);
    }

    function drawFalling(){
      for(const f of state.falling){
        drawHeartLeaf(f.x, f.y, f.s, f.rot, f.alpha, f.col);
      }
    }

    /*****************************************************************
     * LOOP
     *****************************************************************/
    function loop(ts){
      if(!state.started) return;
      if(!state.t0) state.t0 = ts;

      const t = (ts - state.t0) / 1000;
      const { w, h } = stageSize();

      ctx.clearRect(0,0,w,h);
      state.wind = Math.sin(t*0.6) * 0.6;

      if(state.phase === "grow"){
        state.growP = Math.min(1, t / 2.2);
        drawTrunk(state.growP);

        if(state.growP >= 1){
          state.phase = "bloom";
          state.t0 = ts;
          createCanopy();
        }
      } else if(state.phase === "bloom"){
        drawTrunk(1);

        state.bloomP = Math.min(1, t / 2.0);
        drawCanopy(state.bloomP);

        if(state.bloomP > 0.75 && Math.random() < 0.25){
          spawnFalling(isMobile() ? 1 : 2);
        }
        updateFalling();
        drawFalling();

        if(state.bloomP >= 1){
          state.phase = "fall";
          state.t0 = ts;

          textPanel.classList.add("show");
          startTypewriter(TYPEWRITER_TEXT, typingEl, isMobile() ? 22 : 26);
        }
      } else if(state.phase === "fall"){
        drawTrunk(1);
        drawCanopy(1);

        if(Math.random() < (isMobile() ? 0.28 : 0.38)) spawnFalling(isMobile() ? 1 : 2);
        updateFalling();
        drawFalling();
      }

      requestAnimationFrame(loop);
    }

    /*****************************************************************
     * TYPEWRITER
     *****************************************************************/
    async function startTypewriter(text, el, msPerChar=26){
      el.textContent = "";
      const caret = document.createElement("span");
      caret.className = "caret";
      el.appendChild(document.createTextNode(""));
      el.appendChild(caret);

      let out = "";
      for(let i=0;i<text.length;i++){
        out += text[i];
        el.textContent = out;
        el.appendChild(caret);

        const ch = text[i];
        let wait = msPerChar;
        if(ch === "\n") wait = msPerChar * 8;
        if(".!?".includes(ch)) wait = msPerChar * 14;

        await sleep(wait);
      }
    }
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    /*****************************************************************
     * CONTADOR
     *****************************************************************/
    const startDate = new Date(START_DATE_ISO);
    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatDuration(ms){
      const totalSec = Math.floor(ms/1000);
      const days = Math.floor(totalSec / 86400);
      const rem1 = totalSec - days*86400;
      const hours = Math.floor(rem1 / 3600);
      const rem2 = rem1 - hours*3600;
      const mins = Math.floor(rem2 / 60);
      const secs = rem2 - mins*60;
      return `${days} d√≠as ${pad2(hours)} horas ${pad2(mins)} minutos ${pad2(secs)} segundos`;
    }
    function tickCounter(){
      const diff = new Date() - startDate;
      counterValue.textContent = diff >= 0 ? formatDuration(diff) : "0 d√≠as 00 horas 00 minutos 00 segundos";
    }
    setInterval(tickCounter, 250);
    tickCounter();

    /*****************************************************************
     * M√öSICA (robusta)
     *****************************************************************/
    let musicOn = false;
    let triedAutoplay = false;

    function setupMusic(){
      const musicUI = document.getElementById("musicUI");
      if(!SONG_SRC){
        musicUI.classList.add("hidden");
        return;
      }

      song.src = SONG_SRC;
      song.loop = true;
      song.preload = "auto";
      song.volume = parseFloat(vol.value);

      vol.addEventListener("input", () => {
        song.volume = parseFloat(vol.value);
      });

      toggleMusic.addEventListener("click", async () => {
        if(!musicOn){
          try{
            await song.play();
            musicOn = true;
            toggleMusic.textContent = "‚è∏";
          }catch(e){
            toggleMusic.textContent = "Activar m√∫sica";
          }
        }else{
          song.pause();
          musicOn = false;
          toggleMusic.textContent = "‚ñ∂Ô∏é";
        }
      });

      song.addEventListener("error", () => {
        toggleMusic.textContent = "Audio no encontrado";
      });
    }
    setupMusic();

    /*****************************************************************
     * INICIO
     *****************************************************************/
    startBtn.addEventListener("click", async () => {
      if(state.started) return;

      intro.style.transition = "opacity .35s ease, transform .35s ease";
      intro.style.opacity = "0";
      intro.style.transform = "translateY(-26px) scale(.98)";
      setTimeout(() => intro.remove(), 420);

      if(SONG_SRC && !triedAutoplay){
        triedAutoplay = true;
        try{
          await song.play();
          musicOn = true;
          toggleMusic.textContent = "‚è∏";
        }catch(e){
          musicOn = false;
          toggleMusic.textContent = "Activar m√∫sica";
        }
      }

      state.started = true;
      state.phase = "grow";
      state.t0 = 0;
      requestAnimationFrame(loop);
    });
  </script>
</body>
</html>
